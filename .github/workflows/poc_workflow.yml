name: Workflow for POCs
on:
  workflow_dispatch:
    inputs:
      enable_anomalous_call:
        description: 'Make anomalous outbound call'
        required: false
        default: false
        type: boolean
      run_only_anomalous:
        description: 'Run only the anomalous-outbound-call job'
        required: false
        default: false
        type: boolean

jobs:
  tj-actions-simulation:
    if: ${{ github.event.inputs.run_only_anomalous != 'true' }}
    runs-on: ubuntu-22.04
    steps:
      - uses: step-security/harden-runner@rc
        with:
         egress-policy: audit
     
      - name: Checkout
        uses: actions/checkout@v4

  handle-private-key:
    if: ${{ github.event.inputs.run_only_anomalous != 'true' }}
    runs-on: ubuntu-latest
    steps:
    - uses: step-security/harden-runner@rc
      with:
         egress-policy: audit
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Decode and print private key
      env:
        # This is a base64 encoded dummy private key (NOT A REAL KEY)
        # In production, this should be stored in GitHub Secrets
        ENCODED_PRIVATE_KEY: |
          LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tTUlJRXZnSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS2d3Z2dTa0FnRUFBb0lCQVFDN1ZKVFV0OVVzOGNLagpNekVmWXlqaVdBNFI0L00yYlMxR0I0dDdOWHA5OEMzU0M2ZFZNdkR1aWN0R2V1clQ4ak5idkpaSHRDU3VZRWNONXI0RQpKV25YaXNLNVkrVHYra1pnWlBtNXdRQTB3MVd1cGZhUlZQUGhoR2dUN1daeEM3UFJMTjIvaUo5dDJRTGloNzlEMFF1ZwpINFE3clB3SVVDdzdOYjJYSVpHc1VYSzJhZmlJM24vT1NQSHVRR0dCRnhIcWI3VWwzM3lJdUN4UjBJcTVuem1RTENFVApSYm5pRzRoeE5aMEo3a3hwZzdtWk5LQ1JKd0NRSFl0SEhxVVVOTGl4Q01TNDU1cWo5SUhJTVYwbEc0NFhLWEV6U0oxWgpjajZuQ1B6aFJtUXBDd2p0MWJJT0NWU0VKMUppU204YTVTdUpLRkxtQWlVTmtsZnJOckdEMjN1RUlRSURBUUFCQW9JQgpBQUh0QmJZcDBBdzVOTi9lV0ROUDVuekZFYVhSWmM3QUNuc3BQN1VFSUZZeDkrNW5BU1pnc0l1ZUh4VlpiZ25QTTl6RQotLS0tLUVORCBQUklWQVRFIEtFWS0tLS0t
      run: |
        echo "Decoding private key..."
        echo "$ENCODED_PRIVATE_KEY" | base64 -d > private_key.pem
        
        echo "Private key content:"
        cat private_key.pem
  anomalous-outbound-call:
    # Baseline Generation Script:
    # To quickly run this job 100 times for baseline generation, use this script:
    #
    # #!/bin/bash
    # OWNER="your-github-username"
    # REPO="your-repo-name"
    # WORKFLOW_FILE="poc_workflow.yml"
    #
    # echo "Running anomalous job 100 times for baseline generation..."
    # for i in {1..100}; do
    #   echo "Triggering baseline run #$i"
    #   gh workflow run "$WORKFLOW_FILE" \
    #     --repo "$OWNER/$REPO" \
    #     --field enable_anomalous_call=false \
    #     --field run_only_anomalous=true &
    #   
    #   # Add small delay every 20 requests to avoid rate limiting
    #   if (( i % 20 == 0 )); then
    #     sleep 1
    #   fi
    # done
    # wait
    # echo "All 100 baseline runs triggered!"
    runs-on: ubuntu-latest
    steps:
    - uses: step-security/harden-runner@rc
      with:
         egress-policy: audit
         
    - name: Checkout code
      uses: actions/checkout@v3
            
    - name: Run outbound calls from host
      run: |
        start_time=$(date +%s)
        end_time=$((start_time + 30))
        
        while [ $(date +%s) -lt $end_time ]; do
          curl -I https://www.google.com
          curl -I https://goreleaser.com
          sleep 10  # wait 10 seconds between calls
        done

    - name: Run anomalous calls
      if: always()
      run: |
        # Generate a random subdomain
        RANDOM_SUBDOMAIN=$(openssl rand -hex 8)
        ANOMALOUS_DOMAIN="${RANDOM_SUBDOMAIN}.suppress.com"
        
        echo "Making anomalous call to: $ANOMALOUS_DOMAIN"
        
        # Attempt to connect to the random domain (this will likely fail)
        curl -I --max-time 5 "https://$ANOMALOUS_DOMAIN" || true
